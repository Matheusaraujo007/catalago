<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loja — ManchinhaPx Arts</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f0f10; --card:#565555; --accent:#ffcc00; --muted:#bfbfbf; --white:#fff;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Poppins",sans-serif; background:linear-gradient(180deg,#4f4f50,#111);
  color:var(--white);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
header{
  padding:18px 24px; display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(90deg,#2e2e30,#474646); border-bottom:1px solid rgba(109, 106, 106, 0.03);
}
.brand{display:flex; align-items:center; gap:12px}
.brand .logo{width:46px;height:46px;border-radius:8px;background:linear-gradient(135deg,#222,#111);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)}
.search{flex:1; margin:0 20px}
.search input{width:100%; padding:10px 14px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:#0b0b0b; color:var(--white)}

/* Container principal */
.container{max-width:1200px;margin:28px auto;padding:0 18px}
.filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px}
.filters select, .filters button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:var(--white)}

.categoria-bloco { margin-top: 28px; width:100%; }
.categoria-titulo { font-size: 1.4rem; font-weight:700; margin: 0 0 10px 4px; }
.categoria-wrapper { position: relative; display:flex; align-items:center; gap:10px; }

/* Carrossel horizontal (produtos por categoria) */
.categoria-carrossel {
  display:flex;
  gap:14px;
  overflow-x:auto;
  scroll-behavior:smooth;
  padding:10px 6px;
  -webkit-overflow-scrolling: touch;
}
.categoria-carrossel::-webkit-scrollbar{ height:8px; }
.categoria-carrossel::-webkit-scrollbar-thumb{ background: #666; border-radius:8px; }

/* Cada cartão (tamanho fixo para carrossel) */
.product-card {
  min-width: 180px;
  max-width: 180px;
  background: var(--card);
  border-radius:12px;
  padding:10px;
  box-shadow: 0 8px 18px rgba(0,0,0,0.6);
  flex-shrink:0;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.product-card img{ width:100%; height:120px; object-fit:cover; border-radius:8px; }

/* Setas laterais */
.cat-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 12;
  border: none;
  background: rgba(0,0,0,0.5);
  color: #fff;
  width:44px;height:44px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
}
.cat-btn.left { left: -8px; }
.cat-btn.right { right: -8px; }

/* Versão em grade (desktop) — se preferir grade ao invés de carrossel, descomente o uso */
.category-grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(4, 1fr);
  margin-top: 12px;
}
@media(max-width:1100px){ .category-grid{ grid-template-columns: repeat(3,1fr);} }
@media(max-width:800px){ .category-grid{ grid-template-columns: repeat(2,1fr);} }
@media(max-width:480px){ .category-grid{ grid-template-columns: repeat(1,1fr);} }

/* Modais, banners, etc — mantive o seu estilo original (reduzi um pouco para clareza) */
.banner-carousel { position:relative; width:100%; height:300px; overflow:hidden; border-radius:12px; background:#0a0a0a; margin-top:10px; }
.banner-track { display:flex; transition:transform .6s ease-in-out; width:100%; height:100%; }
.banner-track img{ min-width:100%; height:300px; object-fit:cover; border-radius:12px; }

/* Carrinho e botões flutuantes (mantive) */
.cart{position:fixed;right:0;top:0;height:100vh;width:360px;background:#0b0b0b;padding:18px;transform:translateX(100%);transition:transform .28s ease;box-shadow:-8px 0 30px rgba(0,0,0,0.6);z-index:80}
.cart.open{transform:translateX(0)}
.cart-float { position: fixed; bottom: 110px; right: 22px; width: 55px; height: 55px; background: var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; z-index:9998; }

footer{padding:28px 18px;color:var(--muted);text-align:center}

/* pequenas melhorias para evitar "bagunça" */
.categoria-titulo + .categoria-wrapper { margin-bottom: 6px; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">MP</div>
    <div>
      <div style="font-weight:700">ManchinhaPx Arts</div>
      <div style="font-size:12px;color:var(--muted)">Acessórios para caminhão</div>
    </div>
  </div>
  <div class="search"><input id="q" placeholder="Buscar produtos..." /></div>
</header>

<main class="container">
  <section class="banner-carousel" id="bannerCarousel">
    <button class="arrow-btn arrow-left" id="prevBanner">❮</button>
    <div class="banner-track" id="bannerTrack"></div>
    <button class="arrow-btn arrow-right" id="nextBanner">❯</button>
  </section>

  <div class="filters" style="margin-top:18px">
    <select id="filterCategoria"><option value="">Todas categorias</option></select>
    <select id="sort"><option value="recent">Mais recentes</option><option value="price_asc">Preço ↑</option><option value="price_desc">Preço ↓</option></select>
    <button id="clearFilters">Limpar filtros</button>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h2 style="margin:0">Produtos</h2>
    <div style="color:var(--muted)">Mostrando <span id="prodCount">0</span> produtos</div>
  </div>

  <!-- Aqui iremos injetar por-categoria (carrossel + setas) -->
  <div id="categoriesContainer"></div>

</main>

<!-- Modal produto (mantive seu markup) -->
<div class="modal" id="modal" style="display:none">
  <div class="dialog" role="dialog" aria-modal="true" style="background:#131313;padding:18px;border-radius:12px;max-width:720px;margin:auto">
    <button class="close" id="closeModal" style="position:absolute;right:18px;top:18px;background:transparent;border:none;color:#fff;font-size:18px">✕</button>
    <div class="carousel" style="width:100%;height:260px;overflow:hidden">
      <button class="arrow-btn arrow-left" id="prevImg">❮</button>
      <div class="carousel-track" id="carouselTrack" style="display:flex;height:100%"></div>
      <button class="arrow-btn arrow-right" id="nextImg">❯</button>
    </div>
    <div style="margin-top:12px;color:var(--muted)"><h3 id="modalTitle"></h3><p id="modalDesc"></p><div id="modalPrice"></div></div>
  </div>
</div>

<!-- carrinho / whatsapp / footer (mantive funcionalidade) -->
<aside class="cart" id="cart">
  <button id="btnVoltarCarrinho" style="width:100%;margin-bottom:8px">← Voltar</button>
  <h3>Carrinho</h3>
  <div id="cartItems" style="overflow:auto;max-height:65vh;padding-right:6px"></div>
  <div class="total"><div>Total</div><div id="cartTotal">R$ 0,00</div></div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <button id="btnCheckout" style="flex:1">Finalizar compra</button>
    <button id="btnClear">Limpar</button>
  </div>
</aside>

<div class="cart-float" id="cartFloat" role="button" tabindex="0" aria-label="Abrir carrinho">
  <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="7" width="18" height="13" rx="2" stroke="#000" stroke-width="1.6" fill="transparent"/></svg>
  <div class="cart-badge" id="cartCountFloat">0</div>
</div>

<a href="https://wa.me/5588994907177" target="_blank" class="whatsapp-float" aria-label="WhatsApp">
  <svg width="38" height="38" viewBox="0 0 24 24" fill="#fff"><path d="M20.52 3.48A11.77 11.77 0 0 0 12 0a11.77 11.77 0 0 0-8.52 3.48A11.77 11.77 0 0 0 0 12..."/></svg>
</a>

<footer>© ManchinhaPx Arts</footer>

<script>
/* ========== CONFIG ========= */
const BACKEND = "https://catalago-ashen.vercel.app";
const API_BASE = BACKEND + '/api';

let banners = [];
let produtos = [];
let promocoes = [];
let categorias = [];
let cart = JSON.parse(localStorage.getItem('mp_cart') || '[]');

const money = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

document.addEventListener('DOMContentLoaded', () => {
  const q = document.getElementById('q');
  const filterCategoria = document.getElementById('filterCategoria');
  const sortSel = document.getElementById('sort');
  const prodCount = document.getElementById('prodCount');
  const categoriesContainer = document.getElementById('categoriesContainer');
  const cartCountFloat = document.getElementById('cartCountFloat');
  const cartItems = document.getElementById('cartItems');
  const cartTotal = document.getElementById('cartTotal');
  const cartFloat = document.getElementById('cartFloat');
  const modal = document.getElementById('modal');
  const carouselTrack = document.getElementById('carouselTrack');

  /* CARREGAR DADOS */
  async function fetchProdutos(){
    try{
      const r = await fetch(API_BASE + '/produtos');
      produtos = await r.json();
    }catch(e){
      console.error('Erro ao carregar produtos', e);
      produtos = [];
    }
  }
  async function fetchPromocoes(){
    try{ const r = await fetch(API_BASE + '/promocoes'); promocoes = await r.json(); }catch(e){ promocoes = []; }
  }
  async function carregarBanners(){
    try{
      const r = await fetch(API_BASE + '/banner1');
      banners = await r.json();
      const track = document.getElementById('bannerTrack');
      if(!track) return;
      if(!banners.length){ track.innerHTML = '<div style="color:#aaa;text-align:center;width:100%">Nenhum banner</div>'; return; }
      track.innerHTML = banners.map(b=>{
        const img = b.imagem_base64 ? (b.imagem_base64.startsWith('data:image') ? b.imagem_base64 : `data:image/jpeg;base64,${b.imagem_base64}`) : '/placeholder.png';
        return `<img src="${img}" alt="${b.titulo||''}">`;
      }).join('');
      startBannerCarousel();
    }catch(err){ console.error('Erro banners', err); }
  }
  let currentBanner = 0;
  function startBannerCarousel(){
    const track = document.getElementById('bannerTrack'); if(!track) return;
    const prevBtn = document.getElementById('prevBanner'); const nextBtn = document.getElementById('nextBanner');
    prevBtn.onclick = ()=>{ currentBanner = (currentBanner-1 + banners.length)%banners.length; track.style.transform = `translateX(-${currentBanner*100}%)`; };
    nextBtn.onclick = ()=>{ currentBanner = (currentBanner+1)%banners.length; track.style.transform = `translateX(-${currentBanner*100}%)`; };
    setInterval(()=>{ currentBanner = (currentBanner+1)%banners.length; track.style.transform = `translateX(-${currentBanner*100}%)`; }, 6000);
  }

  function aplicarPromocao(prod){
    const precoOriginal = Number(prod.preco || 0);
    const promo = promocoes.find(p => p.nome_produto === prod.nome && p.ativo !== false);
    if(!promo) return { preco: precoOriginal, label: null };
    if(promo.data_fim && new Date(promo.data_fim) < new Date()) return { preco: precoOriginal, label: null };
    if(promo.tipo === 'percentual'){ const preco = precoOriginal * (1 - Number(promo.valor)/100); return { preco, label: `${promo.valor}% OFF` }; }
    const preco = precoOriginal - Number(promo.valor);
    return { preco: Math.max(0, preco), label: `R$ ${Number(promo.valor).toFixed(2)} OFF` };
  }

  /* RENDER CATEGORIAS COMO CARROSSEL COM SETAS (uma sessão por categoria) */
  function renderCategoriasSections(){
    // agrupar por categoria
    const map = {};
    produtos.forEach(p=>{
      const cat = (p.categoria_nome || p.categoria || 'Outros').trim();
      if(!map[cat]) map[cat]=[];
      map[cat].push(p);
    });

    // popular filtro de categorias (select)
    const cats = Object.keys(map);
    filterCategoria.innerHTML = '<option value="">Todas categorias</option>' + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

    // limpar container
    categoriesContainer.innerHTML = '';

    cats.forEach(cat=>{
      const items = map[cat];
      const safeId = 'cat-'+cat.replace(/\s+/g,'_').replace(/[^\w-]/g,'');
      const section = document.createElement('div');
      section.className = 'categoria-bloco';
      section.innerHTML = `
        <h3 class="categoria-titulo">${escapeHtml(cat)}</h3>
        <div class="categoria-wrapper" id="${safeId}-wrapper" style="position:relative">
          <button class="cat-btn left" data-target="${safeId}">❮</button>
          <div class="categoria-carrossel" id="${safeId}"></div>
          <button class="cat-btn right" data-target="${safeId}">❯</button>
        </div>
      `;
      categoriesContainer.appendChild(section);

      const car = section.querySelector('.categoria-carrossel');

      // popular produtos
      items.forEach(p=>{
        const img = p.imagem_base64 ? (p.imagem_base64.startsWith('data:image') ? p.imagem_base64 : `data:image/jpeg;base64,${p.imagem_base64}`) : '/placeholder.png';
        let precoHtml = `<div style="font-weight:700;color:var(--accent)">${money(p.preco)}</div>`;
        if(p.preco_promocional && Number(p.preco_promocional) < Number(p.preco)) {
          precoHtml = `<div><small style="text-decoration:line-through;color:var(--muted)">${money(p.preco)}</small><div style="color:var(--accent);font-weight:700">${money(p.preco_promocional)} <small style="font-size:11px;color:#0f0">PROMO</small></div></div>`;
        }

        const article = document.createElement('article');
        article.className = 'product-card';
        article.innerHTML = `
          <img src="${img}" alt="${escapeHtml(p.nome)}">
          <div style="font-weight:600">${escapeHtml(p.nome)}</div>
          <div style="color:var(--muted);font-size:13px">${escapeHtml(p.categoria_nome||p.categoria||'')}</div>
          ${precoHtml}
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn info" data-id="${p.id}">Ver</button>
            <button class="btn buy" data-id="${p.id}">Adicionar</button>
          </div>
        `;
        car.appendChild(article);
      });

      // adicionar funcionalidade das setas (scroll por "page")
      const btnLeft = section.querySelector('.cat-btn.left');
      const btnRight = section.querySelector('.cat-btn.right');

      const scrollAmount = Math.round(car.clientWidth * 0.9) || 300;
      btnLeft.addEventListener('click', ()=> car.scrollBy({ left: -scrollAmount, behavior: 'smooth' }));
      btnRight.addEventListener('click', ()=> car.scrollBy({ left: scrollAmount, behavior: 'smooth' }));

      // Touch handling: impedir scroll da página quando a intenção for horizontal
      let startX = 0, startY = 0, isDragging = false;
      car.addEventListener('touchstart', (e)=>{
        if(e.touches.length !== 1) return;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isDragging = true;
      }, {passive:true});

      car.addEventListener('touchmove', (e)=>{
        if(!isDragging) return;
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        if(Math.abs(dx) > Math.abs(dy)){ // movimento horizontal dominante
          e.stopPropagation();
          e.preventDefault(); // bloqueia o scroll vertical da página
          // manual scroll (browser faz nativamente, mas preventDefault garante que a página não acompanhe)
          car.scrollLeft -= dx;
          startX = e.touches[0].clientX;
        }
      }, {passive:false});

      car.addEventListener('touchend', ()=>{ isDragging = false; });

      // delegar eventos Ver / Adicionar
      car.addEventListener('click', (ev)=>{
        const t = ev.target;
        if(t.matches('.btn.info')) openProduct(t.dataset.id);
        if(t.matches('.btn.buy')) addToCart(Number(t.dataset.id),1);
      });
    });
  }

  /* FUNÇÕES AUX */
  function escapeHtml(text){ return String(text||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]); }

  function updateCartUI(){
    const count = cart.reduce((s,i)=>s + (i.qt||0), 0);
    cartCountFloat.textContent = count;
    if(cart.length===0) cartItems.innerHTML = '<div style="color:var(--muted);padding:12px">Carrinho vazio</div>';
    else cartItems.innerHTML = cart.map(it=>{
      const prod = produtos.find(p=>p.id==it.id) || {};
      const img = prod.imagem_base64 ? (prod.imagem_base64.startsWith('data:image') ? prod.imagem_base64 : `data:image/jpeg;base64,${prod.imagem_base64}`) : '/placeholder.png';
      return `<div style="display:flex;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)"><img src="${img}" style="width:56px;height:56px;object-fit:cover;border-radius:8px"/><div style="flex:1"><div style="font-weight:600">${escapeHtml(prod.nome||'Produto')}</div><div style="color:var(--muted)">${money(it.price)} x ${it.qt}</div></div></div>`;
    }).join('');
    const total = cart.reduce((s,i)=> s + ((i.price||0)*(i.qt||0)), 0);
    cartTotal.textContent = money(total);
  }

  function addToCart(id,qtd=1){
    const prod = produtos.find(p=>p.id==id);
    if(!prod){ alert('Produto não encontrado'); return; }
    const promo = aplicarPromocao(prod);
    const existing = cart.find(i=>i.id==id);
    if(existing) existing.qt += qtd;
    else cart.push({ id: prod.id, qt: qtd, price: Number(promo.preco || prod.preco) });
    localStorage.setItem('mp_cart', JSON.stringify(cart));
    updateCartUI();
  }

  // OPEN PRODUCT (modal)
  window.openProduct = function(id){
    const p = produtos.find(x=>x.id==id);
    if(!p) return;
    const imgs = Array.isArray(p.imagens) && p.imagens.length ? p.imagens : (p.imagem_base64 ? [p.imagem_base64] : []);
    if(!imgs.length) carouselTrack.innerHTML = '<div style="color:#aaa;padding:24px">Sem imagem</div>';
    else carouselTrack.innerHTML = imgs.map(src => `<img src="${src.startsWith('data:image')?src:`data:image/jpeg;base64,${src}`}" style="width:100%;object-fit:cover">`).join('');
    document.getElementById('modalTitle').textContent = p.nome;
    document.getElementById('modalDesc').textContent = p.descricao||'';
    document.getElementById('modalPrice').innerHTML = money(p.preco);
    modal.style.display = 'block'; document.body.style.overflow = 'hidden';
  };

  document.getElementById('closeModal').addEventListener('click', ()=>{ modal.style.display='none'; document.body.style.overflow='auto'; });

  /* EVENTOS GLOBAIS */
  document.getElementById('btnClear').addEventListener('click', ()=>{ if(confirm('Limpar carrinho?')){ cart=[]; localStorage.removeItem('mp_cart'); updateCartUI(); }});
  cartFloat.addEventListener('click', ()=> document.getElementById('cart').classList.toggle('open'));

  /* BUSCA / FILTRO */
  q.addEventListener('input', ()=>{ renderFiltered(); });
  filterCategoria.addEventListener('change', ()=>{ renderFiltered(); });
  sortSel.addEventListener('change', ()=>{ renderFiltered(); });

  function renderFiltered(){
    // filtar o array produtos conforme filtros, depois renderCategoriasSections com array filtrado
    const term = q.value.trim().toLowerCase();
    const cat = filterCategoria.value;
    let list = produtos.slice();
    if(term) list = list.filter(p => (p.nome + ' ' + (p.categoria_nome||p.categoria||'')).toLowerCase().includes(term));
    if(cat) list = list.filter(p => (p.categoria_nome||p.categoria||'') === cat);
    const s = sortSel.value;
    if(s === 'price_asc') list.sort((a,b)=>Number(a.preco)-Number(b.preco));
    if(s === 'price_desc') list.sort((a,b)=>Number(b.preco)-Number(a.preco));
    if(s === 'recent') list.sort((a,b)=>b.id - a.id);
    prodCount.textContent = list.length;
    // substitui produtos por lista filtrada temporária para render
    const prevProdutos = produtos;
    produtos = list;
    renderCategoriasSections();
    produtos = prevProdutos; // restaura
  }

  /* INICIALIZAÇÃO */
  (async ()=>{
    await Promise.all([fetchProdutos(), fetchPromocoes(), carregarBanners()]);
    renderCategoriasSections();
    updateCartUI();
  })();

});
</script>
</body>
</html>
