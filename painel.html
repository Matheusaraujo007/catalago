<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Empresarial - Cadastro de Produtos</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family:"Poppins",sans-serif; background:linear-gradient(135deg,#e2e8f0,#f8fafc); margin:0; padding:0; overflow-x:hidden; animation:fadeIn 1s ease-in; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
  header { background:linear-gradient(90deg,#1e3a8a,#2563eb); color:white; text-align:center; padding:20px; font-size:1.7em; letter-spacing:1px; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
  main { max-width:950px; margin:40px auto; background:white; padding:35px; border-radius:20px; box-shadow:0 8px 25px rgba(0,0,0,0.1); }
  h2 { color:#1e293b; margin-bottom:20px; position:relative; }
  h2::after { content:""; position:absolute; width:60px; height:3px; bottom:-6px; left:0; background:linear-gradient(90deg,#2563eb,#1e3a8a); border-radius:3px; }
  form { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  label { font-weight:500; color:#334155; }
  input, select, textarea { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; font-size:1em; margin-top:5px; background:#f8fafc; transition:0.3s; }
  input:focus, select:focus, textarea:focus { outline:none; border-color:#2563eb; box-shadow:0 0 5px rgba(37,99,235,0.3); }
  textarea { grid-column:span 2; resize:none; }
  .preview { grid-column:span 2; display:flex; flex-wrap:wrap; gap:10px; }
  .preview img { width:90px; height:90px; object-fit:cover; border-radius:8px; border:1px solid #e2e8f0; transition:transform 0.3s ease; }
  .preview img:hover { transform:scale(1.05); }
  .btn { grid-column:span 2; text-align:right; }
  button { background:linear-gradient(90deg,#2563eb,#1e3a8a); color:white; padding:12px 25px; font-size:1em; border:none; border-radius:10px; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s; }
  button:hover { transform:scale(1.05); box-shadow:0 4px 15px rgba(37,99,235,0.3); }
  #filtroInput { width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1; font-size:1em; margin-bottom:20px; }
  table { width:100%; margin-top:20px; border-collapse:collapse; }
  th, td { border-bottom:1px solid #e2e8f0; padding:12px; text-align:left; vertical-align:middle; }
  th { background:#f1f5f9; color:#1e293b; font-weight:600; }
  tr:hover { background-color:#f9fafb; transform:scale(1.01); }
  .no-data { text-align:center; color:#64748b; font-style:italic; }
  .miniatura img { width:60px; height:60px; border-radius:8px; object-fit:cover; border:1px solid #cbd5e1; transition:0.3s; }
  .acoes button { margin-right:6px; padding:6px 12px; font-size:0.9em; border-radius:6px; }
  .editar { background-color:#16a34a; }
  .editar:hover { background-color:#15803d; transform:scale(1.05); }
  .excluir { background-color:#dc2626; }
  .excluir:hover { background-color:#b91c1c; transform:scale(1.05); }
  .add-cat-btn { background:linear-gradient(90deg,#2563eb,#1e3a8a); color:white; border:none; border-radius:8px; padding:8px 12px; font-size:1.4em; font-weight:bold; width:15px; height:30px; cursor:pointer; position:relative; left:950px; top:-55px; }
</style>
</head>
<body>
<header>ðŸ“¦ Sistema - Cadastro de Produtos</header>
<main>
<h2>Adicionar Novo Produto</h2>

<form id="productForm">
  <div>
    <label>Nome do Produto:</label>
    <input type="text" id="nome" required>
  </div>
  <div>
    <label>Categoria:</label>
    <select id="categoria" required>
      <option value="">Selecione...</option>
    </select>
  </div>

  <button type="button" id="addCategoriaBtn" class="add-cat-btn" title="Adicionar nova categoria">+</button>

  <div>
    <label>PreÃ§o de Venda (R$):</label>
    <input type="number" id="venda" step="0.01" required>
  </div>
  <div>
    <label>Quantidade em Estoque:</label>
    <input type="number" id="estoque" required>
  </div>
  <div>
    <label>CÃ³digo Interno:</label>
    <input type="text" id="codigo" required>
  </div>
  <div style="grid-column: span 2;">
    <label>DescriÃ§Ã£o:</label>
    <textarea id="descricao" rows="3"></textarea>
  </div>
  <div style="grid-column: span 2;">
    <label>Imagens do Produto:</label>
    <input type="file" id="imagens" multiple accept="image/*">
    <div class="preview" id="preview"></div>
  </div>
  <div class="btn">
    <button type="submit">Salvar Produto</button>
  </div>
</form>

<h2>ðŸ“‹ Produtos Cadastrados</h2>
<table id="productTable">
  <thead>
    <tr>
      <th>Imagem</th>
      <th>Nome</th>
      <th>Categoria</th>
      <th>PreÃ§o (R$)</th>
      <th>Estoque</th>
      <th>CÃ³digo</th>
      <th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody>
    <tr class="no-data"><td colspan="7">Nenhum produto cadastrado ainda.</td></tr>
  </tbody>
</table>
</main>

<script>
const form = document.getElementById('productForm');
const tableBody = document.querySelector('#productTable tbody');
const preview = document.getElementById('preview');
const inputImagens = document.getElementById('imagens');

let imagensSelecionadas = [];
let produtos = [];
let produtoEditando = null;

// PrÃ©-visualizaÃ§Ã£o de imagens
inputImagens.addEventListener('change', () => {
  preview.innerHTML = "";
  imagensSelecionadas = [];
  Array.from(inputImagens.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement('img');
      img.src = e.target.result;
      preview.appendChild(img);
      imagensSelecionadas.push(e.target.result);
    };
    reader.readAsDataURL(file);
  });
});

// FunÃ§Ã£o segura pra converter resposta
async function parseResponse(res) {
  const text = await res.text();
  try { return text ? JSON.parse(text) : null; }
  catch { return null; }
}

// Carregar produtos
async function carregarProdutos() {
  try {
    const res = await fetch('/api/produtos');
    produtos = await parseResponse(res) || [];
    atualizarTabela();
  } catch(err) {
    console.error('Erro ao carregar produtos:', err);
    tableBody.innerHTML = `<tr class="no-data"><td colspan="7">Erro ao carregar produtos</td></tr>`;
  }
}

// Atualizar tabela
function atualizarTabela() {
  tableBody.innerHTML = "";
  if(produtos.length === 0) {
    tableBody.innerHTML = `<tr class="no-data"><td colspan="7">Nenhum produto cadastrado ainda.</td></tr>`;
    return;
  }
  produtos.forEach((p,i) => {
    const preco = parseFloat(p.preco || p.venda || 0).toFixed(2);
    const imagem = p.imagens?.length ? `<img src="${p.imagens[0]}"/>` : "â€”";
    const linha = document.createElement('tr');
    linha.innerHTML = `
      <td class="miniatura">${imagem}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${preco}</td>
      <td>${p.estoque}</td>
      <td>${p.codigo}</td>
      <td class="acoes">
        <button class="editar" onclick="editarProduto(${i})">Editar</button>
        <button class="excluir" onclick="excluirProduto(${i})">Excluir</button>
      </td>`;
    tableBody.appendChild(linha);
  });
}

// Adicionar/Editar produto
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const nome = nome.value.trim();
  const categoria = categoria.value;
  const venda = document.getElementById('venda').value;
  const estoque = document.getElementById('estoque').value;
  const codigo = document.getElementById('codigo').value;
  const descricao = document.getElementById('descricao').value;

  if(!nome || !categoria || !venda || !estoque || !codigo){
    alert("Preencha todos os campos obrigatÃ³rios!");
    return;
  }

  try {
    let res, produtoSalvo;
    if(produtoEditando) {
      res = await fetch('/api/produtos', {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ nomeAntigo: produtoEditando.nome, nome, categoria, venda, estoque, codigo, descricao, imagens: imagensSelecionadas })
      });
    } else {
      res = await fetch('/api/produtos', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ nome, categoria, venda, estoque, codigo, descricao, imagens: imagensSelecionadas })
      });
    }

    produtoSalvo = await parseResponse(res);
    if(!produtoSalvo) throw new Error('Falha ao salvar');

    if(produtoEditando) {
      const index = produtos.findIndex(p => p.nome === produtoEditando.nome);
      produtos[index] = produtoSalvo;
      produtoEditando = null;
    } else {
      produtos.unshift(produtoSalvo);
    }

    atualizarTabela();
    form.reset();
    preview.innerHTML = "";
    imagensSelecionadas = [];
    alert("âœ… Produto salvo com sucesso!");
  } catch(err){
    console.error(err);
    alert("Erro ao salvar produto!");
  }
});

// Editar
window.editarProduto = i => {
  produtoEditando = produtos[i];
  document.getElementById('nome').value = produtoEditando.nome;
  document.getElementById('categoria').value = produtoEditando.categoria;
  document.getElementById('venda').value = produtoEditando.preco;
  document.getElementById('estoque').value = produtoEditando.estoque;
  document.getElementById('codigo').value = produtoEditando.codigo;
  document.getElementById('descricao').value = produtoEditando.descricao;
};

// Excluir
window.excluirProduto = async i => {
  if(!confirm("Excluir este produto?")) return;
  const nome = produtos[i].nome;
  try {
    const res = await fetch('/api/produtos', {
      method: 'DELETE',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ nome })
    });
    if(!res.ok) throw new Error();
    produtos.splice(i,1);
    atualizarTabela();
  } catch(err){ alert("Erro ao excluir!"); }
};

// Categorias
async function carregarCategorias(){
  try{
    const res = await fetch('/api/categorias');
    const categorias = await parseResponse(res) || [];
    const select = document.getElementById('categoria');
    select.innerHTML = '<option value="">Selecione...</option>';
    categorias.forEach(cat=>{
      const option = document.createElement('option');
      option.value = cat.nome;
      option.textContent = cat.nome;
      select.appendChild(option);
    });
  } catch(err){ console.error("Erro ao carregar categorias:", err); }
}

carregarProdutos();
carregarCategorias();
</script>
</body>
</html>
